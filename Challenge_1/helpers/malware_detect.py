import requests
import re
import os
from bs4 import BeautifulSoup
import spacy

class Malware:
    def __init__(self, text, nlp):
        self.text = text
        self.nlp = nlp
        with open(os.path.dirname(os.path.realpath(__file__)) + "/auth.sig") as file:
            self.auth_token = file.read().strip()

    def get_malware_details(self, malware, typeof):
        url = "https://mb-api.abuse.ch/api/v1/"
        headers = {"Auth-Key": self.auth_token}
        query = {}
        if typeof=="tag":
          query = {
            "query": "get_taginfo",
            "tag": str(malware),
            "limit": "50"
          }
        req = requests.post(url, data=query, headers=headers)
        return req.json()
        
    def get_info(self):
        ret = []
        for ent in self.nlp(self.text).ents:
          if ent.label_ in ["WORK_OF_ART"]:
            res = self.get_malware_details(ent, "tag")
            ret.append(["Name", str(ent)])
            if res["query_status"]=="ok":
              data = res["data"][0]
              for info in data:
                if data[info]and info not in ["intelligence", "tags", "reporter", "first_seen"]:
                  ret.append([info, data[info]])
        return ret
        '''
        malware_details = []
        file_hashes = re.findall(r'\b([a-fA-F0-9]{32}|[a-fA-F0-9]{40}|[a-fA-F0-9]{64})\b', self.text)
        for file_hash in file_hashes:
            response = requests.get(f'https://www.virustotal.com/gui/file/{file_hash}')
            soup = BeautifulSoup(response.content, 'html.parser')
            malware_name = soup.find('title').text
            malware_details.append({"name": malware_name, "hash": file_hash})
        return malware_details
    '''
        return "none"
